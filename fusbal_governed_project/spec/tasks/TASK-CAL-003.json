{
  "schema_version": 1,
  "task_id": "TASK-CAL-003",
  "intent_id": "INT-020",
  "title": "Manual fallback + explicit calibration quality gating",
  "status": "done",
  "scope": [
    "Provide a minimal manual fallback input format for correspondences when auto-fit fails.",
    "Implement explicit calibration quality gating that controls downstream BEV outputs (trust-first).",
    "Do not build a full UI; focus on an input schema + pipeline integration."
  ],
  "acceptance": [
    "Manual fallback input is explicit and versioned (repeatable, not ad-hoc).",
    "Quality gate has deterministic thresholds and emits diagnostics explaining why BEV output is suppressed.",
    "V1 gating thresholds are explicit (numbers, units) and have no overrides: BEV is allowed only when `rms_reprojection_error_px <= 4.0`, `inlier_ratio >= 0.60`, `num_inliers >= 12`, and `marking_coverage_score_0_to_1 >= 0.50`.",
    "`manual_correspondences.json` is versioned and explicit (V1 minimum schema): `{ \"schema_version\": 1, \"camera_id\": \"...\", \"pitch_template_ref\": { \"pitch_template_id\": \"...\" }, \"correspondences\": [ { \"image_xy_px\": [x, y], \"pitch_xy_m\": [x_m, y_m], \"label\": \"optional\" } ] }`. Validation is deterministic: `correspondences.length >= 12`, each point array has length 2, and all values are finite numbers. For manual outcomes, set `num_inliers = correspondences.length`, `inlier_ratio = 1.0`, and `marking_coverage_score_0_to_1 = 1.0` (V1).",
    "Output contract template documents manual input schema and gating outputs."
  ],
  "deliverables": [
    {
      "deliverable_id": "DELIV-TASK-CAL-003-001",
      "title": "Manual correspondence fallback and quality gate",
      "paths": [
        "pipeline/src/fusbal_pipeline/calibration/manual.py",
        "pipeline/src/fusbal_pipeline/calibration/gating.py",
        "pipeline/fixtures/calibration/venues/example_venue/pitch_a/manual_correspondences.json",
        "pipeline/src/fusbal_pipeline/contract.py"
      ],
      "acceptance": [
        "Manual correspondence inputs can be loaded/validated with clear errors.",
        "Gating emits explicit pass/fail plus diagnostics and never silently produces BEV when calibration is low quality.",
        "Gating diagnostics include the measured metrics and the applied thresholds."
      ],
      "evidence": [
        "A deterministic command exists and demonstrates gating pass/fail with diagnostics on fixtures: `python -m fusbal_pipeline.calibration.gating --inputs pipeline/fixtures/calibration/venues/example_venue/pitch_a/calibration_input.json --result <path-to-auto-fit-result-or-manual-result>` (or equivalent documented CLI entrypoint)."
      ]
    },
    {
      "deliverable_id": "DELIV-TASK-CAL-003-002",
      "title": "Output contract template updated for manual calibration + gating",
      "paths": [
        "spec/md/docs/data/OUTPUT_CONTRACT.mdt"
      ],
      "acceptance": [
        "Contract documents manual input fields, gating outputs, and failure semantics."
      ],
      "evidence": [
        "`npm run generate` renders docs reflecting the updated contract template."
      ]
    }
  ],
  "subtasks": [
    {
      "subtask_id": "SUB-TASK-CAL-003-001",
      "title": "Define and validate manual correspondence input schema (file format + versioning).",
      "status": "done",
      "area": "pipeline",
      "provenance_prefix": "FUSBAL.PIPELINE.TASK_CAL_003.SUB_001",
      "done_when": [
        "Manual input schema is explicit (points/correspondences, coordinate frames, version).",
        "Validation failures are explicit and actionable."
      ]
    },
    {
      "subtask_id": "SUB-TASK-CAL-003-002",
      "title": "Implement explicit calibration quality gating for BEV outputs.",
      "status": "done",
      "area": "pipeline",
      "provenance_prefix": "FUSBAL.PIPELINE.TASK_CAL_003.SUB_002",
      "done_when": [
        "Gate returns pass/fail + diagnostics; BEV output is suppressed on fail.",
        "Diagnostics include reasons and key quality metrics."
      ]
    },
    {
      "subtask_id": "SUB-TASK-CAL-003-003",
      "title": "Update output contract template for manual calibration + gating outputs.",
      "status": "done",
      "area": "spec",
      "provenance_prefix": "FUSBAL.SPEC.TASK_CAL_003.SUB_003",
      "done_when": [
        "Contract template documents manual input schema, gating outputs, and failure semantics."
      ]
    }
  ]
}
