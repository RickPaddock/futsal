{
  "type": "intent_quality_audit_report",
  "schema_version": 1,
  "intent_id": "INT-050",
  "run_id": "20260122_205224",
  "timestamp": "2026-01-22T21:02:15Z",
  "scope": {
    "areas_in_scope": [
      "pipeline",
      "portal",
      "scripts",
      "tools"
    ]
  },
  "audit_inputs": {
    "intent_spec_path": "spec/intents/INT-050.json",
    "task_spec_paths": [
      "spec/tasks/TASK-VIDEO-INGEST-001.json",
      "spec/tasks/TASK-RUN-VIDEO-001.json",
      "spec/tasks/TASK-BALL-DET-BASELINE-001.json",
      "spec/tasks/TASK-BALL-DET-UAT-FIXTURE-SYNTH-001.json",
      "spec/tasks/TASK-EVENTS-DETERMINISTIC-SORT-001.json",
      "spec/tasks/TASK-VALIDATE-STRICT-AND-REPORT-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-VERSION-DIAGNOSTICS-001.json",
      "spec/tasks/TASK-PORTAL-READMODEL-CACHE-TEST-001.json",
      "spec/tasks/TASK-RUN-VIDEO-STREAM-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-TIMEOUT-001.json",
      "spec/tasks/TASK-RUN-VIDEO-NULL-ASSERT-001.json",
      "spec/tasks/TASK-DIAGNOSTICS-BALL-DETECTIONS-001.json",
      "spec/tasks/TASK-SHOTS-GOALS-CONFIG-001.json",
      "spec/tasks/TASK-CONTRACT-BALL-FRAMEIDX-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-NODE-DECOUPLE-001.json",
      "spec/tasks/TASK-BALL-DET-REGRESSION-001.json",
      "spec/tasks/TASK-CLI-EXIT-CODES-001.json",
      "spec/tasks/TASK-PORTAL-AUDIT-RUNS-001.json"
    ],
    "code_paths_reviewed": [
      "spec/intents/INT-050.json",
      "spec/tasks/TASK-VIDEO-INGEST-001.json",
      "spec/tasks/TASK-RUN-VIDEO-001.json",
      "spec/tasks/TASK-BALL-DET-BASELINE-001.json",
      "spec/tasks/TASK-BALL-DET-UAT-FIXTURE-SYNTH-001.json",
      "spec/tasks/TASK-EVENTS-DETERMINISTIC-SORT-001.json",
      "spec/tasks/TASK-VALIDATE-STRICT-AND-REPORT-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-VERSION-DIAGNOSTICS-001.json",
      "spec/tasks/TASK-PORTAL-READMODEL-CACHE-TEST-001.json",
      "spec/tasks/TASK-RUN-VIDEO-STREAM-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-TIMEOUT-001.json",
      "spec/tasks/TASK-RUN-VIDEO-NULL-ASSERT-001.json",
      "spec/tasks/TASK-DIAGNOSTICS-BALL-DETECTIONS-001.json",
      "spec/tasks/TASK-SHOTS-GOALS-CONFIG-001.json",
      "spec/tasks/TASK-CONTRACT-BALL-FRAMEIDX-001.json",
      "spec/tasks/TASK-VIDEO-TOOLS-NODE-DECOUPLE-001.json",
      "spec/tasks/TASK-BALL-DET-REGRESSION-001.json",
      "spec/tasks/TASK-CLI-EXIT-CODES-001.json",
      "spec/tasks/TASK-PORTAL-AUDIT-RUNS-001.json",
      "status/intents/INT-050/intent.md",
      "status/intents/INT-050/scope.json",
      "status/intents/INT-050/work_packages.json",
      "pipeline/src/fusbal_pipeline/cli.py",
      "pipeline/src/fusbal_pipeline/video/ingest.py",
      "pipeline/src/fusbal_pipeline/contract.py",
      "pipeline/src/fusbal_pipeline/ball/detector.py",
      "apps/portal/lib/portal_read_model.js",
      "apps/portal/pages/internal/intents/[intentId].js",
      "tools/evidence/record_run.mjs"
    ]
  },
  "summary": {
    "overall_health_0_to_10": 8,
    "top_risks": [
      "Evidence run.json appears to omit timestamps/status fields (portal run ordering risk).",
      "Timeout/exit-code paths are implemented but not fully test-covered for decode-timeout scenarios.",
      "Generated intent surfaces include null fields (scope/work_packages) which may reduce portal readiness signal."
    ],
    "top_quick_wins": [
      "Fix tools/evidence/record_run.mjs to populate timestamps and type fields.",
      "Add focused pytest cases for ffmpeg/ffprobe timeout behavior.",
      "Add guardrail for null scope/work_packages outputs."
    ]
  },
  "verification": {
    "functional": {
      "status": "pass",
      "notes": "Pipeline + portal tests passed; deliverables present and wired into CLI/portal surfaces."
    },
    "nonfunctional": {
      "correctness_safety": {
        "status": "pass",
        "notes": "Trust-first defaults and deterministic ordering/timebase validated via tests and code review."
      },
      "performance": {
        "status": "pass",
        "notes": "Streaming decode and bounded per-frame processing; portal caching present."
      },
      "security": {
        "status": "pass",
        "notes": "No shell invocation; filesystem reads are internal and path-validated for intent IDs."
      },
      "maintainability": {
        "status": "pass",
        "notes": "Clear module boundaries, schemas/contracts, and tests for key behaviors."
      },
      "overall_status": "pass"
    }
  },
  "improvements": [
    {
      "id": "IMP-001",
      "title": "Populate record_run timestamps/status in run.json for correct portal ordering",
      "area": "tools",
      "roi_0_to_10": 10,
      "effort": "S",
      "risk": "low",
      "why": "Current run.json fields like timestamp_end/status appear null, which can break “latest run” ordering and reduce audit traceability in the portal.",
      "proposed_changes": [
        "tools/evidence/record_run.mjs: set type/status/timestamp_start/timestamp_end/success deterministically",
        "apps/portal/lib/portal_read_model.js:99 consider fallback sort by run_id if timestamp_end missing"
      ]
    },
    {
      "id": "IMP-002",
      "title": "Add tests for ffprobe/ffmpeg timeout and decode-failure exit codes",
      "area": "pipeline",
      "roi_0_to_10": 9,
      "effort": "S",
      "risk": "low",
      "why": "Timeout/exit-code behavior is implemented but only partially covered by tests; failures here directly impact audit reliability and UX.",
      "proposed_changes": [
        "pipeline/tests/test_video_ingest_v1.py: add cases for FUSBAL_FFPROBE_TIMEOUT_S and FUSBAL_FFMPEG_READ_TIMEOUT_S",
        "pipeline/src/fusbal_pipeline/video/ingest.py:170 assert EXIT_CODE_DECODE_FAILED paths are exercised"
      ]
    },
    {
      "id": "IMP-003",
      "title": "Guardrail to prevent null generated intent surfaces (scope/work_packages)",
      "area": "guardrails",
      "roi_0_to_10": 8,
      "effort": "S",
      "risk": "low",
      "why": "status/intents/*/scope.json and work_packages.json are portal-critical; null payloads degrade readiness and work-package visibility.",
      "proposed_changes": [
        "scripts/guardrails/validate_repository.mjs: validate status/intents/*/scope.json has non-null core fields",
        "scripts/generate_all.mjs: fail fast if generator emits null scope/work_packages"
      ]
    },
    {
      "id": "IMP-004",
      "title": "Index audit runs to avoid deep directory scanning on every refresh",
      "area": "portal",
      "roi_0_to_10": 7,
      "effort": "M",
      "risk": "low",
      "why": "listAuditRunsDeep recursively scans all run.json files; as audit history grows, this can slow SSR and refresh actions.",
      "proposed_changes": [
        "apps/portal/lib/portal_read_model.js:63 maintain a lightweight index file under status/portal/",
        "scripts/generate_all.mjs: emit/update audit index during generate"
      ]
    },
    {
      "id": "IMP-005",
      "title": "Harden portal filesystem reads with size limits and surfaced parse errors",
      "area": "portal",
      "roi_0_to_10": 7,
      "effort": "S",
      "risk": "medium",
      "why": "safeReadJson currently swallows parse errors and reads files fully; large/corrupt artefacts can cause silent data loss or latency.",
      "proposed_changes": [
        "apps/portal/lib/portal_read_model.js:18 add max-bytes guard + return structured error details",
        "apps/portal/pages/internal/intents/[intentId].js: display parse/read errors in the UI"
      ]
    },
    {
      "id": "IMP-006",
      "title": "Make run-video validation strictness configurable via CLI flags",
      "area": "pipeline",
      "roi_0_to_10": 6,
      "effort": "S",
      "risk": "low",
      "why": "run-video always validates with strict=false; a strict mode would improve correctness gates for downstream automation without changing defaults.",
      "proposed_changes": [
        "pipeline/src/fusbal_pipeline/cli.py:473 add --strict-validate flag to run-video",
        "pipeline/src/fusbal_pipeline/cli.py:618 ensure strict propagates consistently into collect_bundle_validation_errors"
      ]
    },
    {
      "id": "IMP-007",
      "title": "Add schema validation for diagnostics artefacts (ball_detections.jsonl)",
      "area": "pipeline",
      "roi_0_to_10": 6,
      "effort": "M",
      "risk": "low",
      "why": "Diagnostics JSONL rows are used for audits but are only implicitly structured; a schema reduces drift and makes portal rendering safer.",
      "proposed_changes": [
        "pipeline/schemas/: add a schema for diagnostics/ball_detections.jsonl rows",
        "pipeline/src/fusbal_pipeline/cli.py:448 validate rows before writing (or on validate --strict)"
      ]
    },
    {
      "id": "IMP-008",
      "title": "Improve tool-path override validation (executable bit + absolute normalization)",
      "area": "pipeline",
      "roi_0_to_10": 5,
      "effort": "S",
      "risk": "low",
      "why": "FUSBAL_FFPROBE_PATH/FUSBAL_FFMPEG_PATH accept any file; checking executability and normalizing improves safety and error clarity.",
      "proposed_changes": [
        "pipeline/src/fusbal_pipeline/video/ingest.py:87 verify Path.is_file() and os.access(X_OK) for overrides",
        "pipeline/src/fusbal_pipeline/video/ingest.py:104 include resolved path in errors deterministically"
      ]
    },
    {
      "id": "IMP-009",
      "title": "Add unit tests for deterministic event ordering edge cases",
      "area": "pipeline",
      "roi_0_to_10": 5,
      "effort": "S",
      "risk": "low",
      "why": "Event ordering is deterministic by design; tests for ties (same t_ms/type/conf) would protect against future regressions.",
      "proposed_changes": [
        "pipeline/tests/test_events_v1.py: add a tie-breaker coverage case for _event_sort_key_v1",
        "pipeline/src/fusbal_pipeline/cli.py:69 keep artifact_id tie-breaker stable"
      ]
    },
    {
      "id": "IMP-010",
      "title": "Remove OS-specific artefacts from pipeline tree via guardrails (e.g. .DS_Store)",
      "area": "guardrails",
      "roi_0_to_10": 4,
      "effort": "S",
      "risk": "low",
      "why": "OS-generated files create noisy diffs and can confuse tooling that walks directories.",
      "proposed_changes": [
        "scripts/guardrails/validate_repository.mjs: flag common OS artefacts under tracked directories",
        ".gitignore: ensure .DS_Store is ignored (if not already)"
      ]
    }
  ]
}
